<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess.com Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { background-color: #262421; color: #bababa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        .chess-card { background-color: #2d2b29; border-radius: 4px; border-bottom: 3px solid #21201d; }
        .stat-label { color: #989795; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .stat-value { color: #fff; font-size: 1.75rem; font-weight: 800; line-height: 1.2; }
        .header-text { color: #fff; font-size: 1.5rem; font-weight: 700; }
        
        /* Custom Win/Draw/Loss Bar */
        .outcome-container { margin-top: 8px; }
        .outcome-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; background-color: #3c3a37; }
        .bar-win { background-color: #81b64c; }
        .bar-draw { background-color: #989795; }
        .bar-loss { background-color: #fa3633; }
        .rating-subtext { font-size: 0.7rem; color: #989795; margin-top: 4px; font-weight: 600; }
    </style>
</head>
<body class="p-6 md:p-12">

    <div class="max-w-5xl mx-auto">
        <div class="mb-8">
            <h1 class="header-text">Inzichten</h1>
            <p class="text-sm text-[#989795]">Gedetailleerde statistieken van je partijen</p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="chess-card p-5">
                <p class="stat-label">Winstpercentage</p>
                <div id="winRate" class="stat-value">--%</div>
                <div id="winBarContainer" class="outcome-container"></div>
            </div>
            <div class="chess-card p-5">
                <p class="stat-label">Gem. Nauwkeurigheid</p>
                <div id="avgAccuracy" class="stat-value">--</div>
            </div>
            <div class="chess-card p-5">
                <p class="stat-label">Aantal Partijen</p>
                <div id="totalGames" class="stat-value">0</div>
            </div>
            <div class="chess-card p-5">
                <p class="stat-label">Gem. Tegenstander</p>
                <div id="avgRating" class="stat-value">0</div>
                <div id="ratingBreakdown" class="rating-subtext"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="chess-card p-6 lg:col-span-1">
                <h3 class="text-white font-bold mb-6 flex items-center gap-2">
                    <span class="w-1 h-5 bg-[#81b64c]"></span> Kwaliteit van de zetten
                </h3>
                <canvas id="moveQualityChart" height="400"></canvas>
            </div>
            <div class="chess-card p-6 lg:col-span-2">
                <h3 class="text-white font-bold mb-6 flex items-center gap-2">
                    <span class="w-1 h-5 bg-[#81b64c]"></span> Rating Verloop
                </h3>
                <canvas id="ratingChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        const moveColors = {
            'Briljant': '#1ba39c', 'Beste': '#95bb4a', 'Uitstekend': '#96bc4b', 
            'Goed': '#a88d59', 'Boek': '#d5a47d', 'Onnauwkeurigheid': '#f0c15c',
            'Fout': '#e6912c', 'Blunder': '#b33430', 'Gemiste Winstkans': '#dbac16'
        };

        const moveOrder = [
            'Briljant', 'Beste', 'Uitstekend', 'Goed', 
            'Boek', 'Onnauwkeurigheid', 'Fout', 'Blunder', 'Gemiste Winstkans'
        ];

        window.onload = async () => {
            try {
                const moveRes = await fetch('./moves.json');
                const moveData = await moveRes.json();
                renderMoveChart(moveData);

                const gameRes = await fetch('./games.csv');
                const csvText = await gameRes.text();
                
                Papa.parse(csvText, {
                    header: true, 
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: (results) => processGames(results.data)
                });
            } catch (error) {
                console.error("Error loading data:", error);
            }
        };

        function processGames(data) {
            const clean = data.filter(r => r.accuracy != null);
            const total = clean.length;
            
            // Logic for Win/Draw/Loss
            const wins = clean.filter(r => String(r.result).toLowerCase() === 'win');
            const draws = clean.filter(r => String(r.result).toLowerCase() === 'draw');
            const losses = clean.filter(r => String(r.result).toLowerCase() === 'loss');

            const winPct = ((wins.length / total) * 100);
            const drawPct = ((draws.length / total) * 100);
            const lossPct = ((losses.length / total) * 100);

            // Update Win Rate UI
            document.getElementById('winRate').innerText = winPct.toFixed(1) + '%';
            document.getElementById('winBarContainer').innerHTML = `
                <div class="outcome-bar">
                    <div class="bar-win" style="width: ${winPct}%"></div>
                    <div class="bar-draw" style="width: ${drawPct}%"></div>
                    <div class="bar-loss" style="width: ${lossPct}%"></div>
                </div>
            `;

            // Opponent Rating Logic
            const getAvg = (arr) => arr.length ? Math.round(arr.reduce((a,b) => a + (b.opponent_rating || 0), 0) / arr.length) : 0;
            
            document.getElementById('avgRating').innerText = getAvg(clean);
            document.getElementById('ratingBreakdown').innerText = `W: ${getAvg(wins)} | D: ${getAvg(draws)} | L: ${getAvg(losses)}`;

            // Other Stats
            document.getElementById('avgAccuracy').innerText = (clean.reduce((a,b)=>a+b.accuracy,0)/total).toFixed(1);
            document.getElementById('totalGames').innerText = total;

            renderRatingHistoryChart(clean);
        }

        function renderMoveChart(data) {
            // Sort data based on moveOrder array
            const sortedLabels = moveOrder.filter(label => data.hasOwnProperty(label));
            const sortedValues = sortedLabels.map(label => data[label]);

            new Chart(document.getElementById('moveQualityChart'), {
                type: 'bar',
                data: {
                    labels: sortedLabels,
                    datasets: [{
                        data: sortedValues,
                        backgroundColor: sortedLabels.map(l => moveColors[l] || '#555'),
                        borderRadius: 4
                    }]
                },
                options: { 
                    indexAxis: 'y', 
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#312e2b' }, ticks: { color: '#989795' } },
                        y: { grid: { display: false }, ticks: { color: '#fff' } }
                    }
                }
            });
        }

        function renderRatingHistoryChart(data) {
            new Chart(document.getElementById('ratingChart'), {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Rating',
                        data: data.map(r => r.my_rating),
                        borderColor: '#81b64c',
                        backgroundColor: 'rgba(129, 182, 76, 0.1)',
                        fill: true,
                        tension: 0.2,
                        pointRadius: 2,
                        pointBackgroundColor: '#81b64c'
                    }]
                },
                options: { 
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { grid: { color: '#312e2b' }, ticks: { color: '#989795' } },
                        x: { display: false }
                    } 
                }
            });
        }
    </script>
</body>
</html>
