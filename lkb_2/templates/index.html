<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess.com Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { background-color: #262421; color: #bababa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        .chess-card { background-color: #2d2b29; border-radius: 4px; border-bottom: 3px solid #21201d; }
        .stat-label { color: #989795; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .stat-value { color: #fff; font-size: 1.75rem; font-weight: 800; }
        .header-text { color: #fff; font-size: 1.5rem; font-weight: 700; }
    </style>
</head>
<body class="p-6 md:p-12">

    <div class="max-w-5xl mx-auto">
        <div class="mb-8">
            <h1 class="header-text">Inzichten</h1>
            <p class="text-sm text-[#989795]">Automatisch geladen vanuit Flask Backend</p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="chess-card p-5">
                <p class="stat-label">Winstpercentage</p>
                <div id="winRate" class="stat-value">--%</div>
            </div>
            <div class="chess-card p-5">
                <p class="stat-label">Gem. Nauwkeurigheid</p>
                <div id="avgAccuracy" class="stat-value">--</div>
            </div>
            <div class="chess-card p-5">
                <p class="stat-label">Aantal Partijen</p>
                <div id="totalGames" class="stat-value">0</div>
            </div>
            <div class="chess-card p-5">
                <p class="stat-label">Gem. Tegenstander</p>
                <div id="avgRating" class="stat-value">0</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="chess-card p-6 lg:col-span-1">
                <h3 class="text-white font-bold mb-6 flex items-center gap-2">
                    <span class="w-1 h-5 bg-[#81b64c]"></span> Kwaliteit van de zetten
                </h3>
                <canvas id="moveQualityChart" height="400"></canvas>
            </div>
            <div class="chess-card p-6 lg:col-span-2">
                <h3 class="text-white font-bold mb-6 flex items-center gap-2">
                    <span class="w-1 h-5 bg-[#81b64c]"></span> Nauwkeurigheid vs. Zetten
                </h3>
                <canvas id="accuracyChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        const moveColors = {
            'Briljant': '#1ba39c', 'Beste': '#95bb4a', 'Uitstekend': '#96bc4b', 
            'Goed': '#a88d59', 'Boek': '#d5a47d', 'Onnauwkeurigheid': '#f0c15c',
            'Fout': '#e6912c', 'Blunder': '#b33430', 'Gemiste Winstkans': '#dbac16'
        };

        // Fetch and process data on load
        window.onload = async () => {
            // 1. Load JSON Move Data
            const moveRes = await fetch('/api/moves');
            const moveData = await moveRes.json();
            renderMoveChart(moveData);

            // 2. Load CSV Game Data
            const gameRes = await fetch('/api/games');
            const csvText = await gameRes.text();
            Papa.parse(csvText, {
                header: true, dynamicTyping: true,
                complete: (results) => processGames(results.data)
            });
        };

        function processGames(data) {
            const clean = data.filter(r => r.accuracy != null);
            const wins = clean.filter(r => String(r.result).toLowerCase() === 'win').length;
            
            document.getElementById('winRate').innerText = ((wins/clean.length)*100).toFixed(1) + '%';
            document.getElementById('avgAccuracy').innerText = (clean.reduce((a,b)=>a+b.accuracy,0)/clean.length).toFixed(1);
            document.getElementById('totalGames').innerText = clean.length;
            document.getElementById('avgRating').innerText = Math.round(clean.reduce((a,b)=>a+(b.opponent_rating||0),0)/clean.length);

            new Chart(document.getElementById('accuracyChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        data: clean.map(r => ({ x: r.moves, y: r.accuracy })),
                        backgroundColor: '#81b64c'
                    }]
                },
                options: { scales: { y: { min: 0, max: 100 } }, plugins: { legend: { display: false } } }
            });
        }

        function renderMoveChart(data) {
            new Chart(document.getElementById('moveQualityChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: Object.keys(data).map(l => moveColors[l] || '#555')
                    }]
                },
                options: { indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>